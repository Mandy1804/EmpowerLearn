<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login e Cadastro - EmpowerLearn</title>
    <link rel="stylesheet" href="../EmpowerLearn/css/style.css"> 	
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <header>
        <div class="container">
            <a href="../EmpowerLearn/index.html" class="logo-link"> 
                <div class="logo">
                    <img src="../EmpowerLearn/imagens/Logo.PNG" alt="EmpowerLearn Logo">
                    <h1>EmpowerLearn</h1>
                </div>
            </a>
            <nav>
                <ul class="nav-links">
                    <li><a href="../EmpowerLearn/index.html">Início</a></li>
                    <li><a href="../EmpowerLearn/sobre.html">Sobre Nós</a></li>
                    <li><a href="../EmpowerLearn/como-funcionna.html">Como Funciona</a></li>
                    <li><a href="../EmpowerLearn/diferenciais.html">Diferenciais</a></li>
                    <li><a href="../EmpowerLearn/contato.html">Contato</a></li>
                    <li><a href="../EmpowerLearn/login.html" class="active">Login</a></li>
                </ul>
                <div class="burger">
                    <div class="line1"></div>
                    <div class="line2"></div>
                    <div class="line3"></div>
                </div>
            </nav>
        </div>
    </header>

    <main>
        <section id="auth-container" class="section-padded">
            <div class="auth-box">
                <div class="auth-tabs">
                    <button class="tab-button active" data-tab="login">Login</button>
                    <button class="tab-button" data-tab="cadastro">Cadastrar</button>
                </div>

                <div id="login-form" class="auth-form active">
                    <form id="form-login-api" action="#" method="POST">
                        <div class="form-message hidden" id="login-message"></div> 
                        
                        <div class="form-group">
                            <label for="login-email">E-mail</label>
                            <input type="email" id="login-email" name="login-email" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="login-senha">Senha</label>
                            <input type="password" id="login-senha" name="login-senha" required>
                        </div>
                        
                        <button type="submit" class="btn-primary">Entrar</button>
                    </form>
                </div>

                <div id="cadastro-form" class="auth-form hidden">
                    <div class="form-group">
                        <label for="tipo-cadastro">Você é:</label>
                        <select id="tipo-cadastro" name="tipo-cadastro" required>
                            <option value="" disabled selected>Selecione</option>
                            <option value="aluno">Aluno</option>
                            <option value="professor">Professor</option>
                            <option value="instituicao">Instituição</option>
                        </select>
                    </div>

                    <form id="form-aluno" action="#" method="POST" class="cadastro-subform hidden">
                        <div id="aluno-message" class="form-message hidden"></div>
                        <div class="form-group">
                            <label for="aluno-nome">Nome Completo</label>
                            <input type="text" id="aluno-nome" name="aluno-nome" required>
                        </div>
                        <div class="form-group">
                            <label for="aluno-nascimento">Data de Nascimento</label>
                            <input type="date" id="aluno-nascimento" name="aluno-nascimento" required>
                        </div>
                        <div class="form-group">
                            <label for="aluno-email">E-mail</label>
                            <input type="email" id="aluno-email" name="aluno-email" required>
                        </div>
                        <div class="form-group">
                            <label for="aluno-cep">CEP</label>
                            <input type="text" id="aluno-cep" name="aluno-cep" required>
                        </div>
                        <div class="form-group">
                            <label for="aluno-sexo">Sexo</label>
                            <select id="aluno-sexo" name="aluno-sexo" required>
                                <option value="" disabled selected>Selecione</option>
                                <option value="masculino">Masculino</option>
                                <option value="feminino">Feminino</option>
                                <option value="outro">Prefiro não informar</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="aluno-senha">Senha</label>
                            <input type="password" id="aluno-senha" name="aluno-senha" required>
                        </div>
                        <div class="form-group">
                            <label for="aluno-confirmar-senha">Confirmar Senha</label>
                            <input type="password" id="aluno-confirmar-senha" name="aluno-confirmar-senha" required>
                        </div>
                        <button type="submit" class="btn-primary">Cadastrar como Aluno</button>
                    </form>

                    <form id="form-professor" action="#" method="POST" class="cadastro-subform hidden">
                        <div id="professor-message" class="form-message hidden"></div>
                        <div class="form-group">
                            <label for="prof-nome">Nome Completo</label>
                            <input type="text" id="prof-nome" name="prof-nome" required>
                        </div>
                        <div class="form-group">
                            <label for="prof-email">E-mail</label>
                            <input type="email" id="prof-email" name="prof-email" required>
                        </div>
                        <div class="form-group">
                            <label for="prof-cep">CEP</label>
                            <input type="text" id="prof-cep" name="prof-cep" required>
                        </div>
                        <div class="form-group">
                            <label for="prof-materia">Qual a matéria que leciona?</label>
                            <input type="text" id="prof-materia" name="prof-materia" required>
                        </div>
                        <div class="form-group">
                            <label for="prof-multiplas-materias">Leciona mais de uma matéria? (Se sim, quais?)</label>
                            <textarea id="prof-multiplas-materias" name="prof-multiplas-materias" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="prof-didatica">Qual sua forma didática?</label>
                            <textarea id="prof-didatica" name="prof-didatica" rows="3" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="prof-experiencia">Anos de experiência (ex: 5)</label>
                            <input type="number" id="prof-experiencia" name="prof-experiencia" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="prof-senha">Senha</label>
                            <input type="password" id="prof-senha" name="prof-senha" required>
                        </div>
                        <div class="form-group">
                            <label for="prof-confirmar-senha">Confirmar Senha</label>
                            <input type="password" id="prof-confirmar-senha" name="prof-confirmar-senha" required>
                        </div>
                        <button type="submit" class="btn-primary">Cadastrar como Professor</button>
                    </form>

                    <form id="form-instituicao" action="#" method="POST" class="cadastro-subform hidden">
                        <div id="instituicao-message" class="form-message hidden"></div>
                        <div class="form-group">
                            <label for="inst-nome">Nome da Instituição</label>
                            <input type="text" id="inst-nome" name="inst-nome" required>
                        </div>
                        <div class="form-group">
                            <label for="inst-email">E-mail</label>
                            <input type="email" id="inst-email" name="inst-email" required>
                        </div>
                        <div class="form-group">
                            <label for="inst-cep">CEP</label>
                            <input type="text" id="inst-cep" name="inst-cep" required>
                        </div>
                        <div class="form-group">
                            <label for="inst-senha">Senha</label>
                            <input type="password" id="inst-senha" name="inst-senha" required>
                        </div>
                        <div class="form-group">
                            <label for="inst-confirmar-senha">Confirmar Senha</label>
                            <input type="password" id="inst-confirmar-senha" name="inst-confirmar-senha" required>
                        </div>
                        <button type="submit" class="btn-primary">Cadastrar como Instituição</button>
                    </form>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2024 EmpowerLearn. Todos os direitos reservados.</p>
            <div class="social-links">
                <a href="https://www.instagram.com/empowerlearn.teach/" target="_blank">Instagram</a> |
                <a href="https://wa.me/5544988094397" target="_blank">WhatsApp</a> |
                <a href="mailto:empowerlearn.teach@gmail.com">E-mail</a>
            </div>
        </div>
    </footer>

    <script>
        const API_BASE_URL = 'http://localhost:8080/api';
        // CORRIGIDO: Página de destino (se necessário, verifique o caminho)
        const PAGINA_DESTINO = 'daschboard.html'; 

        // ----------------------------------------------------
        // FUNÇÕES AUXILIARES
        // ----------------------------------------------------

        function showMessage(element, type, message) {
            const messageDiv = element.querySelector('.form-message') || document.getElementById(`${element.id.replace('form-', '')}-message`) || document.getElementById('login-message');

            if (messageDiv) {
                messageDiv.textContent = message;
                messageDiv.classList.remove('hidden', 'success', 'error');
                messageDiv.classList.add(type);
                messageDiv.style.display = 'block';
            }
        }

        async function handleLogin(email, senha) {
            // Tenta logar em todas as entidades até encontrar o usuário
            const entities = ['professores', 'alunos', 'instituicoes'];
            let userData = null;
            let userType = null;
            
            for (const entity of entities) {
                try {
                    const endpoint = `${API_BASE_URL}/${entity}/login`;
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, senha })
                    });

                    if (response.ok) {
                        userData = await response.json();
                        userType = entity.slice(0, -1); // Remove 's' para obter 'professor', 'aluno', etc.
                        break;
                    }
                } catch (error) {
                    console.error(`Erro ao tentar login em ${entity}:`, error);
                }
            }

            if (userData && userData.id) {
                // SALVAMENTO DA SESSÃO: Chave para carregar o perfil
                localStorage.setItem('userId', userData.id); 
                localStorage.setItem('userType', userType);
                
                showMessage(document.getElementById('form-login-api'), 'success', `Login como ${userType} bem-sucedido! Redirecionando...`);
                
                setTimeout(() => {
                    window.location.href = PAGINA_DESTINO; 
                }, 1000); 

            } else {
                 showMessage(document.getElementById('form-login-api'), 'error', 'E-mail ou senha inválidos. Tente novamente.');
            }
        }
        
        // ----------------------------------------------------
        // LÓGICA DE CADASTRO (API)
        // ----------------------------------------------------
        async function submitRegistration(e, entityPath, formFields) {
            e.preventDefault();
            const form = e.currentTarget;
            const messageDiv = form.querySelector('.form-message');
            const senha = formFields.senha.value;
            const confirmarSenha = formFields.confirmarSenha.value;

            if (senha !== confirmarSenha) {
                return showMessage(form, 'error', 'As senhas não coincidem. Por favor, verifique.');
            }
            
            const cepValue = formFields.cep.value.replace(/\D/g, ''); 
            if (cepValue.length !== 8) {
                 return showMessage(form, 'error', 'O CEP deve conter 8 dígitos.');
            }

            const dataToSend = {
                nome: formFields.nome.value,
                email: formFields.email.value,
                senha: senha,
                cep: cepValue,
                dataCadastro: new Date().toISOString().split('T')[0],
                ...formFields.specificData
            };

            try {
                const response = await fetch(`${API_BASE_URL}/${entityPath}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dataToSend)
                });

                if (response.ok) {
                    showMessage(form, 'success', 'Cadastro realizado com sucesso! Faça login.');
                    form.reset();
                } else {
                    const errorText = await response.text();
                    showMessage(form, 'error', errorText || `Erro ${response.status}: Falha no cadastro.`);
                }
            } catch (error) {
                console.error('Erro de conexão:', error);
                showMessage(form, 'error', 'Erro de rede: Não foi possível conectar à API.');
            }
        }


        // ----------------------------------------------------
        // EVENTOS GERAIS
        // ----------------------------------------------------
        document.addEventListener('DOMContentLoaded', function () {
            const tabButtons = document.querySelectorAll('.tab-button');
            const authForms = document.querySelectorAll('.auth-form');
            const tipoCadastroSelect = document.getElementById('tipo-cadastro');
            const cadastroSubforms = document.querySelectorAll('.cadastro-subform');
            const loginFormApi = document.getElementById('form-login-api');

            // Troca de Abas
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tab = button.dataset.tab;
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    authForms.forEach(form => form.classList.add('hidden'));
                    button.classList.add('active');
                    document.getElementById(`${tab}-form`).classList.remove('hidden');
                    document.getElementById(`${tab}-form`).classList.add('active');
                    
                    // Lógica para mostrar/ocultar o tipo de cadastro
                    if (tab === 'cadastro') {
                        cadastroSubforms.forEach(form => form.classList.add('hidden'));
                        const tipo = tipoCadastroSelect.value;
                        if (tipo) {
                            document.getElementById(`form-${tipo}`).classList.remove('hidden');
                        }
                    }
                });
            });

            // Troca de Tipo de Cadastro
            tipoCadastroSelect.addEventListener('change', (e) => {
                const tipo = e.target.value;
                cadastroSubforms.forEach(form => form.classList.add('hidden'));
                if (tipo) {
                    document.getElementById(`form-${tipo}`).classList.remove('hidden');
                }
            });

            // LIGAÇÃO DOS FORMULÁRIOS
            
            // Login (Professor, Aluno, Instituição)
            if (loginFormApi) {
                loginFormApi.addEventListener('submit', async function(e) {
                    e.preventDefault(); 
                    const email = document.getElementById('login-email').value;
                    const senha = document.getElementById('login-senha').value;
                    await handleLogin(email, senha);
                });
            }

            // Cadastro de ALUNO
            document.getElementById('form-aluno').addEventListener('submit', async function(e) {
                submitRegistration(e, 'alunos', {
                    nome: document.getElementById('aluno-nome'),
                    email: document.getElementById('aluno-email'),
                    senha: document.getElementById('aluno-senha'),
                    confirmarSenha: document.getElementById('aluno-confirmar-senha'),
                    cep: document.getElementById('aluno-cep'),
                    specificData: {
                        dataNascimento: document.getElementById('aluno-nascimento').value,
                        sexo: document.getElementById('aluno-sexo').value,
                    }
                });
            });

            // Cadastro de PROFESSOR
            document.getElementById('form-professor').addEventListener('submit', async function(e) {
                submitRegistration(e, 'professores', {
                    nome: document.getElementById('prof-nome'),
                    email: document.getElementById('prof-email'),
                    senha: document.getElementById('prof-senha'),
                    confirmarSenha: document.getElementById('prof-confirmar-senha'),
                    cep: document.getElementById('prof-cep'),
                    specificData: {
                        especialidade: document.getElementById('prof-materia').value,
                        multiplasMaterias: document.getElementById('prof-multiplas-materias').value,
                        didatica: document.getElementById('prof-didatica').value,
                        experiencia: parseInt(document.getElementById('prof-experiencia').value),
                    }
                });
            });

            // Cadastro de INSTITUIÇÃO
            document.getElementById('form-instituicao').addEventListener('submit', async function(e) {
                submitRegistration(e, 'instituicoes', {
                    nome: document.getElementById('inst-nome'),
                    email: document.getElementById('inst-email'),
                    senha: document.getElementById('inst-senha'),
                    confirmarSenha: document.getElementById('inst-confirmar-senha'),
                    cep: document.getElementById('inst-cep'),
                    specificData: {
                        // Nenhuma data específica necessária no momento
                    }
                });
            });
        });
    </script>
    <script src="../EmpowerLearn/js/script.js"></script>
</body>
</html>